<!DOCTYPE html>
<html lang="id">
<head>
  <link rel="stylesheet" href="../css/style.css" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Riwayat Chat - FisioSehat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body class="bg-[#e6d3c7] text-sm min-h-screen flex flex-col">

<!-- Header -->
<header class="bg-[#f472b6] text-white px-4 py-3 shadow flex items-center justify-between">
  <h1 class="text-lg font-semibold">üìÅ Riwayat Chat</h1>
  <a href="dashboard.html" class="text-white underline text-sm">Kembali</a>
</header>

<!-- Main -->
<main class="flex-1 max-w-md w-full mx-auto p-4 space-y-4">
  <!-- Daftar Riwayat -->
  <div>
    <label class="block font-medium mb-1">Daftar Riwayat:</label>
    <ul id="daftarRiwayat" class="space-y-2"></ul>
  </div>

  <!-- Chat Box -->
  <div id="chatContainer" class="hidden">
    <div id="chatBox" class="bg-white rounded p-3 h-64 overflow-y-auto space-y-2 shadow"></div>
  </div>
</main>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDng3ugBylPgzuxZA1YRPavo5br5jjlodo",
    authDomain: "fisiosehat-af9f1.firebaseapp.com",
    projectId: "fisiosehat-af9f1",
    storageBucket: "fisiosehat-af9f1.appspot.com",
    messagingSenderId: "800971487968",
    appId: "1:800971487968:web:0dec5977632004aa0fee85"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const daftarRiwayat = document.getElementById("daftarRiwayat");
  const chatBox = document.getElementById("chatBox");
  const chatContainer = document.getElementById("chatContainer");

  let currentEmail = "";

  auth.onAuthStateChanged(user => {
    if (user) {
      currentEmail = user.email;
      tampilkanRiwayat();
    } else {
      window.location.href = "login.html";
    }
  });

  function tampilkanRiwayat() {
    db.collection("sessions")
      .where("selesai", "==", true)
      .where("kepada", "==", currentEmail)
      .orderBy("dibuat", "desc") // üîÅ pastikan index Firestore dibuat
      .onSnapshot(snapshot => {
        daftarRiwayat.innerHTML = "";

        if (snapshot.empty) {
          daftarRiwayat.innerHTML = `<li class="text-gray-500 italic">Belum ada riwayat konsultasi selesai.</li>`;
          return;
        }

        snapshot.forEach(doc => {
          const data = doc.data();
          const item = document.createElement("li");
          item.className = "bg-white p-3 rounded shadow cursor-pointer hover:bg-pink-50 transition";
          item.innerHTML = `
            <div class="font-semibold">${data.namaPasien || "Pasien"}</div>
            <div class="text-xs text-gray-500">${doc.id}</div>
          `;
          item.addEventListener("click", () => {
            bukaRiwayat(doc.id);
          });

          daftarRiwayat.appendChild(item);
        });
      }, err => {
        console.error("üî• Gagal load riwayat:", err.message);
      });
  }

  function bukaRiwayat(sessionId) {
    chatContainer.classList.remove("hidden");
    chatBox.innerHTML = "";

    db.collection("chats")
      .where("sessionId", "==", sessionId)
      .orderBy("waktu", "asc")
      .onSnapshot(snapshot => {
        chatBox.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const waktu = data.waktu?.toDate();
          const jam = waktu?.getHours().toString().padStart(2, "0");
          const menit = waktu?.getMinutes().toString().padStart(2, "0");
          const isAdmin = data.dari === "Admin";

          const div = document.createElement("div");
          if (isAdmin) {
            div.className = "flex flex-col items-end max-w-[80%] ml-auto";
            div.innerHTML = `
              <div class="bg-white text-black text-sm rounded-xl rounded-br-none px-3 py-2 shadow">
                ${data.pesan}
                <span class="text-xs text-gray-600 ml-2">${jam}.${menit}</span>
              </div>`;
          } else {
            div.className = "bg-[#f472b6] text-white text-sm rounded-xl rounded-tl-none px-3 py-2 max-w-[80%] break-words shadow";
            div.innerHTML = `${data.pesan}
              <span class="text-xs text-white ml-2">${jam}.${menit}</span>`;
          }

          chatBox.appendChild(div);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
      });
  }
</script>
</body>
</html>
