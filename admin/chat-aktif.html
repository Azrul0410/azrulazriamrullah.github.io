<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat Aktif - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-[#e6d3c7] text-black font-sans">

<header class="bg-pink-500 text-white px-4 py-3 text-center font-semibold shadow">
  Chat Aktif Pasien
</header>

<main class="max-w-md mx-auto p-4 space-y-4">
  <select id="sessionSelect" class="w-full border px-3 py-2 rounded">
    <option value="">-- Pilih Sesi --</option>
  </select>

  <div id="chatBox" class="bg-[#e6d3c7] rounded shadow p-4 h-[55vh] overflow-y-auto space-y-2"></div>

  <form id="chatForm" class="flex gap-2">
    <input type="text" id="inputPesan" placeholder="Ketik pesan..." class="flex-1 border px-4 py-2 rounded-full" />
    <button class="bg-pink-500 text-white px-4 py-2 rounded-full">Kirim</button>
  </form>

  <button id="btnAkhiri" class="text-sm text-red-600 underline hover:text-red-800">Akhiri Chat</button>
</main>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDng3ugBylPgzuxZA1YRPavo5br5jjlodo",
    authDomain: "fisiosehat-af9f1.firebaseapp.com",
    projectId: "fisiosehat-af9f1"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentEmail = "";
  let currentSessionId = "";

  const sessionSelect = document.getElementById("sessionSelect");
  const chatBox = document.getElementById("chatBox");
  const inputPesan = document.getElementById("inputPesan");

  auth.onAuthStateChanged(user => {
    if (user) {
      currentEmail = user.email;
      loadSesiAktif();
    } else {
      alert("Anda belum login.");
      location.href = "login.html";
    }
  });

  function loadSesiAktif() {
    db.collection("sessions")
      .where("kepada", "==", currentEmail)
      .where("selesai", "==", false)
      .orderBy("dibuat", "asc")
      .onSnapshot(snapshot => {
        sessionSelect.innerHTML = `<option value="">-- Pilih Sesi --</option>`;
        snapshot.forEach(doc => {
          const data = doc.data();
          const option = document.createElement("option");
          option.value = doc.id;
          option.textContent = `${doc.data().namaPasien || 'Pasien'} - ${doc.id}`;
          sessionSelect.appendChild(option);
        });
      });
  }

  sessionSelect.addEventListener("change", () => {
    currentSessionId = sessionSelect.value;
    if (!currentSessionId) return;
    tampilkanChat(currentSessionId);
  });

  function tampilkanChat(sessionId) {
    db.collection("chats")
      .where("sessionId", "==", sessionId)
      .orderBy("waktu", "asc")
      .onSnapshot(snapshot => {
        chatBox.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const waktu = data.waktu?.toDate();
          const jam = waktu?.getHours().toString().padStart(2, "0");
          const menit = waktu?.getMinutes().toString().padStart(2, "0");

          const bubble = document.createElement("div");
          const isAdmin = data.dari === "Admin";

          if (isAdmin) {
            bubble.className = "flex flex-col items-end max-w-[80%] ml-auto";
            bubble.innerHTML = `
              <div class="bg-white text-black px-3 py-2 rounded-xl rounded-br-none shadow">
                ${data.pesan}
                <div class="text-xs text-right text-gray-600">${jam}.${menit}</div>
              </div>`;
          } else {
            bubble.className = "flex flex-col max-w-[80%]";
            bubble.innerHTML = `
              <div class="bg-[#f472b6] text-white px-3 py-2 rounded-xl rounded-tl-none shadow">
                ${data.pesan}
                <div class="text-xs text-right text-white">${jam}.${menit}</div>
              </div>`;
          }

          chatBox.appendChild(bubble);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
      });
  }

  document.getElementById("chatForm").addEventListener("submit", e => {
    e.preventDefault();
    const pesan = inputPesan.value.trim();
    if (!pesan || !currentSessionId) return;

    db.collection("chats").add({
      dari: "Admin",
      kepada: currentSessionId,
      pesan,
      sessionId: currentSessionId,
      waktu: firebase.firestore.Timestamp.now()
    });

    inputPesan.value = "";
  });

  document.getElementById("btnAkhiri").addEventListener("click", () => {
    if (!currentSessionId) return;
    if (confirm("Akhiri sesi chat ini?")) {
      db.collection("sessions").doc(currentSessionId).update({ selesai: true });
      alert("Sesi diakhiri");
      currentSessionId = "";
      chatBox.innerHTML = "";
    }
  });
</script>
</body>
</html>
