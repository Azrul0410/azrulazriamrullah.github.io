<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Akun Saya - FisioKita</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-[#f8fafc] text-black min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-[#4B6CC1] text-white px-4 py-3 flex justify-between items-center shadow">
    <h1 class="text-lg font-semibold">👤 Akun Saya</h1>
    <button id="logoutBtn" class="text-sm underline hover:text-gray-200">Logout</button>
  </header>

  <!-- Main -->
  <main class="flex-1 p-6 max-w-md mx-auto w-full space-y-10">

    <!-- PROFIL -->
    <section id="profilPasien" class="hidden space-y-4">
      <h2 class="text-lg font-semibold mb-1">Profil Anda</h2>
      <div class="bg-white p-4 rounded shadow text-sm space-y-2">
        <p><strong>Nama:</strong> <span id="profilNama">-</span></p>
        <p><strong>Email:</strong> <span id="profilEmail">-</span></p>
        <p><strong>No. HP:</strong> <span id="profilHP">-</span></p>
        <p><strong>Lokasi:</strong> <span id="profilLokasi">-</span></p>
        <p><strong>Jenis Kelamin:</strong> <span id="profilGender">-</span></p>
        <p><strong>Tanggal Lahir:</strong> <span id="profilLahir">-</span></p>
        <p class="text-xs text-gray-500 mt-2">📆 Login terakhir: <span id="profilLogin">-</span></p>
        <div class="text-right mt-2">
          <button onclick="document.getElementById('editFormSection').classList.toggle('hidden')" class="text-sm text-blue-600 hover:underline">✏️ Edit Profil</button>
        </div>
      </div>
    </section>

    <!-- FORM EDIT -->
    <section id="editFormSection" class="hidden">
      <h2 class="text-lg font-semibold mb-2">✏️ Ubah Profil</h2>
      <form id="editForm" class="space-y-3 text-sm bg-white p-4 rounded shadow">
        <input type="text" id="editNama" placeholder="Nama Lengkap" class="w-full border rounded px-3 py-2" required />
        <input type="tel" id="editHP" placeholder="Nomor HP" class="w-full border rounded px-3 py-2" required />
        <input type="date" id="editTglLahir" class="w-full border rounded px-3 py-2" required />
        <select id="editGender" class="w-full border rounded px-3 py-2" required>
          <option value="">Pilih Jenis Kelamin</option>
          <option value="Laki-laki">Laki-laki</option>
          <option value="Perempuan">Perempuan</option>
        </select>
        <select id="editProvinsi" class="w-full border rounded px-3 py-2" required></select>
        <select id="editKabupaten" class="w-full border rounded px-3 py-2" required></select>
        <button type="submit" class="bg-[#4B6CC1] text-white w-full py-2 rounded hover:bg-[#3a57b0]">Simpan Perubahan</button>
        <p id="pesanEdit" class="text-sm text-center mt-2"></p>
      </form>
    </section>

    <!-- GANTI PASSWORD -->
    <section>
      <h2 class="text-lg font-semibold mb-2">🔐 Ganti Kata Sandi</h2>
      <form id="formGantiPassword" class="bg-white p-4 rounded shadow space-y-3 text-sm">
        <input type="password" id="passwordLama" placeholder="Password Lama" class="w-full border rounded px-3 py-2" required />
        <input type="password" id="passwordBaru" placeholder="Password Baru" class="w-full border rounded px-3 py-2" required />
        <button type="submit" class="bg-[#4B6CC1] text-white w-full py-2 rounded hover:bg-[#3a57b0] transition">Simpan Password Baru</button>
        <p id="pesanPassword" class="text-sm text-center mt-2"></p>
      </form>
    </section>

    <!-- LUPA PASSWORD -->
    <section>
      <h2 class="text-lg font-semibold mb-2">📧 Lupa Kata Sandi?</h2>
      <button id="btnResetPassword" class="text-sm underline text-blue-600">Kirim Link Reset ke Email</button>
      <p id="pesanReset" class="text-sm text-center mt-2"></p>
    </section>

    <!-- HAPUS AKUN -->
    <section>
      <h2 class="text-lg font-semibold mb-2 text-red-600">⚠️ Hapus Akun</h2>
      <button id="hapusAkunBtn" class="text-sm underline text-red-600">Hapus akun secara permanen</button>
      <p id="pesanHapus" class="text-sm text-center mt-2"></p>
    </section>

    <!-- RIWAYAT -->
    <section>
      <h2 class="text-lg font-semibold mb-2">📁 Riwayat Konsultasi</h2>
      <ul id="daftarRiwayat" class="space-y-3 text-sm">
        <li class="text-gray-500 italic">Memuat riwayat...</li>
      </ul>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-[#4B6CC1] text-white text-xs mt-12">
    <div class="max-w-md mx-auto px-4 py-6 space-y-4">
      <div class="flex items-center gap-2">
        <img src="img/logo.png" alt="Logo" class="w-5 h-5" />
        <span class="font-semibold">Fisio Kita</span>
      </div>
      <p class="text-sm">Layanan fisioterapi terpercaya - Pilih fisioterapis dan pesan janji temu online.</p>
      <div>
        <h3 class="font-semibold mb-1">Navigasi</h3>
        <ul class="space-y-1">
          <li><a href="index.html" class="hover:underline text-white">🏠 Beranda</a></li>
          <li><a href="konsultasi-jenis.html" class="hover:underline text-white">🩺 Konsultasi</a></li>
          <li><a href="edukasi.html" class="hover:underline text-white">📚 Edukasi</a></li>
        </ul>
      </div>
      <p class="text-center text-[10px] opacity-70">© 2025 Fisio Kita.</p>
    </div>
  </footer>

  <!-- Script -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDng3ugBylPgzuxZA1YRPavo5br5jjlodo",
      authDomain: "fisiosehat-af9f1.firebaseapp.com",
      projectId: "fisiosehat-af9f1",
      storageBucket: "fisiosehat-af9f1.appspot.com"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Auto load user
    auth.onAuthStateChanged(async user => {
      if (!user) return location.href = "login.html";
      const uid = user.uid;
      const email = user.email;

      const doc = await db.collection("pengguna").doc(uid).get();
      if (doc.exists) {
        const d = doc.data();
        document.getElementById("profilNama").textContent = d.nama || "-";
        document.getElementById("profilEmail").textContent = email;
        document.getElementById("profilHP").textContent = d.hp || "-";
        document.getElementById("profilLokasi").textContent = `${d.kabupaten || "-"}, ${d.provinsi || "-"}`;
        document.getElementById("profilGender").textContent = d.jenis_kelamin || "-";
        document.getElementById("profilLahir").textContent = d.tanggal_lahir || "-";
        document.getElementById("profilLogin").textContent = new Date(user.metadata.lastSignInTime).toLocaleString();

        if (d.foto) document.getElementById("fotoProfil").src = d.foto;
        isiFormEdit(d);
        document.getElementById("profilPasien").classList.remove("hidden");
      }

      // Load riwayat
      db.collection("sessions")
        .where("kontak", "==", email)
        .orderBy("dibuat", "desc")
        .onSnapshot(snapshot => {
          const list = document.getElementById("daftarRiwayat");
          list.innerHTML = "";
          if (snapshot.empty) {
            list.innerHTML = "<li class='italic text-gray-500'>Belum ada riwayat.</li>";
            return;
          }
          snapshot.forEach(doc => {
            const d = doc.data();
            const tgl = d.dibuat?.toDate()?.toLocaleDateString() || "-";
            list.innerHTML += `
              <li class="bg-white p-3 rounded shadow border">
                <div class="font-semibold">${d.namaPasien || "Pasien"}</div>
                <div class="text-xs text-gray-500 mb-1">${tgl}</div>
                <div class="text-sm mb-1">${d.keluhan || "-"}</div>
                <div class="text-xs ${d.selesai ? 'text-green-600' : 'text-orange-600'} font-semibold">
                  ${d.selesai ? "✅ Selesai" : "⏳ Sedang Berlangsung"}
                </div>
              </li>`;
          });
        });
    });

    // Form isi wilayah
    let wilayahData = {};
    fetch("data/wilayah.json").then(res => res.json()).then(data => {
      wilayahData = data;
      const prov = document.getElementById("editProvinsi");
      Object.keys(data).forEach(p => prov.innerHTML += `<option value="${p}">${p}</option>`);
      prov.addEventListener("change", () => {
        const kab = document.getElementById("editKabupaten");
        kab.innerHTML = "";
        Object.keys(data[prov.value] || {}).forEach(k => kab.innerHTML += `<option value="${k}">${k}</option>`);
      });
    });

    function isiFormEdit(data) {
      document.getElementById("editNama").value = data.nama || "";
      document.getElementById("editHP").value = data.hp || "";
      document.getElementById("editTglLahir").value = data.tanggal_lahir || "";
      document.getElementById("editGender").value = data.jenis_kelamin || "";
      document.getElementById("editProvinsi").value = data.provinsi || "";
      document.getElementById("editProvinsi").dispatchEvent(new Event("change"));
      setTimeout(() => {
        document.getElementById("editKabupaten").value = data.kabupaten || "";
      }, 300);
    }

    document.getElementById("editForm").addEventListener("submit", async e => {
      e.preventDefault();
      const user = auth.currentUser;
      const uid = user.uid;
      const file = document.getElementById("editFoto").files[0];
      const data = {
        nama: document.getElementById("editNama").value.trim(),
        hp: document.getElementById("editHP").value.trim(),
        tanggal_lahir: document.getElementById("editTglLahir").value,
        jenis_kelamin: document.getElementById("editGender").value,
        provinsi: document.getElementById("editProvinsi").value,
        kabupaten: document.getElementById("editKabupaten").value,
        email: user.email
      };
      await db.collection("pengguna").doc(uid).set(data, { merge: true });
      alert("✅ Profil berhasil diperbarui");
      location.reload();
    });

    document.getElementById("formGantiPassword").addEventListener("submit", async e => {
      e.preventDefault();
      const oldPass = document.getElementById("passwordLama").value;
      const newPass = document.getElementById("passwordBaru").value;
      const user = auth.currentUser;
      const cred = firebase.auth.EmailAuthProvider.credential(user.email, oldPass);
      try {
        await user.reauthenticateWithCredential(cred);
        await user.updatePassword(newPass);
        document.getElementById("pesanPassword").textContent = "✅ Password berhasil diperbarui.";
      } catch (err) {
        document.getElementById("pesanPassword").textContent = "❌ " + err.message;
      }
    });

    document.getElementById("btnResetPassword").addEventListener("click", () => {
      const email = auth.currentUser.email;
      firebase.auth().sendPasswordResetEmail(email)
        .then(() => document.getElementById("pesanReset").textContent = "✅ Link reset telah dikirim.")
        .catch(err => document.getElementById("pesanReset").textContent = "❌ " + err.message);
    });

    document.getElementById("hapusAkunBtn").addEventListener("click", async () => {
      const user = auth.currentUser;
      const confirm = prompt("Masukkan password Anda untuk hapus akun:");
      if (!confirm) return;
      const cred = firebase.auth.EmailAuthProvider.credential(user.email, confirm);
      try {
        await user.reauthenticateWithCredential(cred);
        await db.collection("pengguna").doc(user.uid).delete();
        await user.delete();
        alert("Akun berhasil dihapus.");
        location.href = "index.html";
      } catch (err) {
        document.getElementById("pesanHapus").textContent = "❌ " + err.message;
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      auth.signOut().then(() => location.href = "index.html");
    });
  </script>
</body>
</html>
