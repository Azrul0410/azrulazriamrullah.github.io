<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Akun Saya - FisioKita</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-[#f8fafc] text-black min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-[#4B6CC1] text-white px-4 py-3 flex justify-between items-center shadow">
    <h1 class="text-lg font-semibold">👤 Akun Saya</h1>
    <button id="logoutBtn" class="text-sm underline hover:text-gray-200">Logout</button>
  </header>

  <!-- Main -->
  <main class="flex-1 p-6 max-w-md mx-auto w-full space-y-10">

    <!-- PROFIL -->
    <section id="profilPasien" class="hidden space-y-4">
      <h2 class="text-lg font-semibold mb-1">Profil Anda</h2>
      <div class="bg-white p-4 rounded shadow text-sm space-y-2">
        <p><strong>Nama:</strong> <span id="profilNama">-</span></p>
        <p><strong>Email:</strong> <span id="profilEmail">-</span></p>
        <p><strong>No. HP:</strong> <span id="profilHP">-</span></p>
        <p><strong>Lokasi:</strong> <span id="profilLokasi">-</span></p>
        <p><strong>Jenis Kelamin:</strong> <span id="profilGender">-</span></p>
        <p><strong>Tanggal Lahir:</strong> <span id="profilLahir">-</span></p>
        <p class="text-xs text-gray-500 mt-2">📆 Login terakhir: <span id="profilLogin">-</span></p>
      </div>

      <!-- Form Edit Profil -->
      <div class="mt-4">
        <h3 class="text-sm font-semibold mb-2">✏️ Ubah Profil</h3>
        <form id="formEditProfil" class="bg-white p-4 rounded shadow space-y-3 text-sm">
          <input type="text" id="editNama" placeholder="Nama Lengkap" class="w-full border rounded px-3 py-2" />
          <input type="text" id="editHP" placeholder="Nomor HP" class="w-full border rounded px-3 py-2" />
          <input type="text" id="editLokasi" placeholder="Lokasi" class="w-full border rounded px-3 py-2" />
          <select id="editGender" class="w-full border rounded px-3 py-2">
            <option value="">Pilih Jenis Kelamin</option>
            <option value="Laki-laki">Laki-laki</option>
            <option value="Perempuan">Perempuan</option>
          </select>
          <input type="date" id="editLahir" class="w-full border rounded px-3 py-2" />
          <button type="submit" class="bg-[#4B6CC1] text-white w-full py-2 rounded hover:bg-[#3a57b0] transition">
            Simpan Perubahan
          </button>
          <p id="pesanEdit" class="text-sm text-center mt-2"></p>
        </form>
      </div>
    </section>

    <!-- GANTI PASSWORD -->
    <section>
      <h2 class="text-lg font-semibold mb-2">🔐 Ganti Kata Sandi</h2>
      <form id="formGantiPassword" class="bg-white p-4 rounded shadow space-y-3 text-sm">
        <input type="password" id="passwordLama" placeholder="Password Lama" class="w-full border rounded px-3 py-2" required />
        <input type="password" id="passwordBaru" placeholder="Password Baru" class="w-full border rounded px-3 py-2" required />
        <button type="submit" class="bg-[#4B6CC1] text-white w-full py-2 rounded hover:bg-[#3a57b0] transition">
          Simpan Password Baru
        </button>
        <p id="pesanPassword" class="text-sm text-center mt-2"></p>
      </form>
    </section>

    <!-- LUPA PASSWORD -->
    <section>
      <h2 class="text-lg font-semibold mb-2">📧 Lupa Kata Sandi?</h2>
      <button id="btnResetPassword" class="text-sm underline text-blue-600">Kirim Link Reset ke Email</button>
      <p id="pesanReset" class="text-sm text-center mt-2"></p>
    </section>

    <!-- HAPUS AKUN -->
    <section>
      <h2 class="text-lg font-semibold mb-2 text-red-600">⚠️ Hapus Akun</h2>
      <button id="hapusAkunBtn" class="text-sm underline text-red-600">Hapus akun secara permanen</button>
      <p id="pesanHapus" class="text-sm text-center mt-2"></p>
    </section>

    <!-- RIWAYAT -->
    <section>
      <h2 class="text-lg font-semibold mb-2">📁 Riwayat Konsultasi</h2>
      <ul id="daftarRiwayat" class="space-y-3 text-sm">
        <li class="text-gray-500 italic">Memuat riwayat...</li>
      </ul>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-[#4B6CC1] text-white text-xs mt-12">
    <div class="max-w-md mx-auto px-4 py-6 space-y-4">
      <div class="flex items-center gap-2">
        <img src="img/logo.png" alt="Logo" class="w-5 h-5" />
        <span class="font-semibold">Fisio Kita</span>
      </div>
      <p class="text-sm">Layanan fisioterapi terpercaya - Pilih fisioterapis dan pesan janji temu online.</p>
      <div>
        <h3 class="font-semibold mb-1">Navigasi</h3>
        <ul class="space-y-1">
          <li><a href="index.html" class="hover:underline text-white">🏠 Beranda</a></li>
          <li><a href="konsultasi-jenis.html" class="hover:underline text-white">🩺 Konsultasi</a></li>
          <li><a href="edukasi.html" class="hover:underline text-white">📚 Edukasi</a></li>
        </ul>
      </div>
      <p class="text-center text-[10px] opacity-70">© 2025 Fisio Kita.</p>
    </div>
  </footer>

  <!-- Firebase & Logic -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDng3ugBylPgzuxZA1YRPavo5br5jjlodo",
      authDomain: "fisiosehat-af9f1.firebaseapp.com",
      projectId: "fisiosehat-af9f1"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const profilSection = document.getElementById("profilPasien");
    const profilNama = document.getElementById("profilNama");
    const profilEmail = document.getElementById("profilEmail");
    const profilHP = document.getElementById("profilHP");
    const profilLokasi = document.getElementById("profilLokasi");
    const profilGender = document.getElementById("profilGender");
    const profilLahir = document.getElementById("profilLahir");
    const profilLogin = document.getElementById("profilLogin");
    const daftarRiwayat = document.getElementById("daftarRiwayat");

    auth.onAuthStateChanged(async (user) => {
      if (!user) return location.href = "login.html";
      const email = user.email;
      const doc = await db.collection("terapis").doc(email).get();
      if (doc.exists) return location.href = "admin/dashboard.html";

      const userDoc = await db.collection("users").doc(email).get();
      if (userDoc.exists) {
        const d = userDoc.data();
        profilNama.textContent = d.nama || "-";
        profilEmail.textContent = email;
        profilHP.textContent = d.hp || "-";
        profilLokasi.textContent = d.lokasi || "-";
        profilGender.textContent = d.gender || "-";
        profilLahir.textContent = d.lahir || "-";
        profilLogin.textContent = new Date(user.metadata.lastSignInTime).toLocaleString();

        document.getElementById("editNama").value = d.nama || "";
        document.getElementById("editHP").value = d.hp || "";
        document.getElementById("editLokasi").value = d.lokasi || "";
        document.getElementById("editGender").value = d.gender || "";
        document.getElementById("editLahir").value = d.lahir || "";

        profilSection.classList.remove("hidden");
      }

      db.collection("sessions")
        .where("kontak", "==", email)
        .orderBy("dibuat", "desc")
        .onSnapshot(snapshot => {
          daftarRiwayat.innerHTML = "";
          if (snapshot.empty) {
            daftarRiwayat.innerHTML = "<li class='italic text-gray-500'>Belum ada riwayat.</li>";
            return;
          }
          snapshot.forEach(doc => {
            const d = doc.data();
            const tgl = d.dibuat?.toDate()?.toLocaleDateString() || "-";
            daftarRiwayat.innerHTML += `
              <li class="bg-white p-3 rounded shadow border">
                <div class="font-semibold">${d.namaPasien || "Pasien"}</div>
                <div class="text-xs text-gray-500 mb-1">${tgl}</div>
                <div class="text-sm mb-1">${d.keluhan || "-"}</div>
                <div class="text-xs ${d.selesai ? 'text-green-600' : 'text-orange-600'} font-semibold">
                  ${d.selesai ? "✅ Selesai" : "⏳ Sedang Berlangsung"}
                </div>
              </li>
            `;
          });
        });
    });

    document.getElementById("formEditProfil").addEventListener("submit", (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      const email = user.email;

      const data = {
        nama: document.getElementById("editNama").value,
        hp: document.getElementById("editHP").value,
        lokasi: document.getElementById("editLokasi").value,
        gender: document.getElementById("editGender").value,
        lahir: document.getElementById("editLahir").value,
      };

      db.collection("users").doc(email).set(data, { merge: true })
        .then(() => document.getElementById("pesanEdit").textContent = "✅ Profil berhasil diperbarui.")
        .catch(err => document.getElementById("pesanEdit").textContent = "❌ " + err.message);
    });

    document.getElementById("formGantiPassword").addEventListener("submit", async (e) => {
      e.preventDefault();
      const oldPass = document.getElementById("passwordLama").value;
      const newPass = document.getElementById("passwordBaru").value;
      const pesan = document.getElementById("pesanPassword");
      try {
        const user = auth.currentUser;
        const cred = firebase.auth.EmailAuthProvider.credential(user.email, oldPass);
        await user.reauthenticateWithCredential(cred);
        await user.updatePassword(newPass);
        pesan.textContent = "✅ Password berhasil diperbarui.";
        pesan.className = "text-green-600 text-sm text-center";
      } catch (err) {
        pesan.textContent = "❌ " + err.message;
        pesan.className = "text-red-600 text-sm text-center";
      }
    });

    document.getElementById("btnResetPassword").addEventListener("click", () => {
      const email = auth.currentUser.email;
      firebase.auth().sendPasswordResetEmail(email)
        .then(() => {
          document.getElementById("pesanReset").textContent = "✅ Link reset telah dikirim.";
          document.getElementById("pesanReset").className = "text-green-600 text-sm text-center";
        })
        .catch(err => {
          document.getElementById("pesanReset").textContent = "❌ " + err.message;
          document.getElementById("pesanReset").className = "text-red-600 text-sm text-center";
        });
    });

    document.getElementById("hapusAkunBtn").addEventListener("click", async () => {
      const user = auth.currentUser;
      const email = user.email;
      const confirm = prompt("Masukkan password Anda untuk menghapus akun:");
      if (!confirm) return;

      const pesan = document.getElementById("pesanHapus");

      try {
        const cred = firebase.auth.EmailAuthProvider.credential(email, confirm);
        await user.reauthenticateWithCredential(cred);
        await user.delete();
        await db.collection("users").doc(email).delete();
        alert("Akun Anda berhasil dihapus.");
        location.href = "index.html";
      } catch (err) {
        pesan.textContent = "❌ " + err.message;
        pesan.className = "text-red-600 text-sm text-center";
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      auth.signOut().then(() => location.href = "index.html");
    });
  </script>
</body>
</html>
