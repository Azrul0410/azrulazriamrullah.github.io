<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Login / Daftar - FisioKita</title>
  <link rel="stylesheet" href="css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body>

  <main style="max-width: 420px; margin: 3rem auto; padding: 2rem; background: white; border-radius: 1rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
    <h1 class="heading-title" style="margin-bottom: 1rem;">Fisio Kita</h1>

    <!-- Tabs -->
    <div style="display: flex; justify-content: center; gap: 1.5rem; margin-bottom: 1.5rem;">
      <button id="btnLoginTab" class="text-[#2970F2] underline font-semibold text-sm">Login</button>
      <button id="btnRegisterTab" class="text-gray-400 font-semibold text-sm">Register</button>
    </div>

    <!-- Login Form -->
    <form id="loginForm">
      <div class="form-group" style="margin-bottom: 1rem;">
        <label for="loginEmail" class="text-sm font-medium">Email</label>
        <input type="email" id="loginEmail" class="w-full border rounded px-3 py-2 text-sm" required />
      </div>
      <div class="form-group" style="margin-bottom: 1rem;">
        <label for="loginPassword" class="text-sm font-medium">Password</label>
        <input type="password" id="loginPassword" class="w-full border rounded px-3 py-2 text-sm" required />
      </div>
      <button type="submit" class="btn-primary w-full">Masuk</button>
    </form>

    <!-- Register Form -->
    <form id="registerForm" class="hidden" style="margin-top: 1.5rem;">
      <div class="form-group"><label>Nama Lengkap</label><input id="regNama" required class="w-full border rounded px-3 py-2 text-sm" /></div>
      <div class="form-group"><label>No. HP</label><input id="regHP" required class="w-full border rounded px-3 py-2 text-sm" /></div>
      <div class="form-group"><label>Tanggal Lahir</label><input type="date" id="regTanggalLahir" required class="w-full border rounded px-3 py-2 text-sm" /></div>
      <div class="form-group"><label>Jenis Kelamin</label>
        <select id="regGender" required class="w-full border rounded px-3 py-2 text-sm">
          <option value="">Pilih</option>
          <option>Laki-laki</option>
          <option>Perempuan</option>
        </select>
      </div>
      <div class="form-group"><label>Provinsi</label><select id="regProvinsi" required class="w-full border rounded px-3 py-2 text-sm"></select></div>
      <div class="form-group"><label>Kabupaten</label><select id="regKabupaten" required class="w-full border rounded px-3 py-2 text-sm"></select></div>
      <div class="form-group"><label>Email</label><input type="email" id="registerEmail" required class="w-full border rounded px-3 py-2 text-sm" /></div>
      <div class="form-group"><label>Password</label><input type="password" id="registerPassword" required class="w-full border rounded px-3 py-2 text-sm" /></div>
      <button type="submit" class="btn-primary w-full">Daftar</button>
    </form>

    <button id="googleLoginBtn" class="btn-white w-full mt-4">Login dengan Google</button>
    <a href="index.html" class="btn-white w-full mt-2 text-center">Kembali ke Beranda</a>
    <p id="pesan" class="text-sm text-red-600 text-center mt-3"></p>
  </main>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDng3ugBylPgzuxZA1YRPavo5br5jjlodo",
      authDomain: "fisiosehat-af9f1.firebaseapp.com",
      projectId: "fisiosehat-af9f1"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const btnLoginTab = document.getElementById("btnLoginTab");
    const btnRegisterTab = document.getElementById("btnRegisterTab");
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    const pesan = document.getElementById("pesan");

    btnLoginTab.onclick = () => {
      loginForm.classList.remove("hidden");
      registerForm.classList.add("hidden");
      btnLoginTab.classList.add("text-[#2970F2]", "underline");
      btnRegisterTab.classList.remove("text-[#2970F2]", "underline");
      pesan.textContent = "";
    };

    btnRegisterTab.onclick = () => {
      loginForm.classList.add("hidden");
      registerForm.classList.remove("hidden");
      btnRegisterTab.classList.add("text-[#2970F2]", "underline");
      btnLoginTab.classList.remove("text-[#2970F2]", "underline");
      pesan.textContent = "";
    };

    function tampilkanPesan(teks) {
      pesan.textContent = teks;
    }

    async function cekDanRedirect(user) {
      const email = user.email.toLowerCase();
      if (email === "fisiokita@gmail.com") {
        location.href = "admin/super-admin-dashboard.html";
      } else {
        const doc = await db.collection("terapis").doc(email).get();
        location.href = doc.exists ? "admin/dashboard.html" : "akun.html";
      }
    }

    loginForm.onsubmit = (e) => {
      e.preventDefault();
      const email = loginEmail.value;
      const pass = loginPassword.value;
      auth.signInWithEmailAndPassword(email, pass)
        .then(res => cekDanRedirect(res.user))
        .catch(err => tampilkanPesan("❌ " + err.message));
    };

    registerForm.onsubmit = async (e) => {
      e.preventDefault();
      const nama = regNama.value;
      const hp = regHP.value;
      const tgl = regTanggalLahir.value;
      const gender = regGender.value;
      const prov = regProvinsi.value;
      const kab = regKabupaten.value;
      const email = registerEmail.value;
      const pass = registerPassword.value;

      if (!nama || !hp || !tgl || !gender || !prov || !kab || pass.length < 6) {
        return tampilkanPesan("❌ Lengkapi semua kolom dan password minimal 6 karakter.");
      }

      try {
        const res = await auth.createUserWithEmailAndPassword(email, pass);
        await db.collection("pengguna").doc(res.user.uid).set({
          nama, hp, tanggal_lahir: tgl, jenis_kelamin: gender,
          provinsi: prov, kabupaten: kab, email
        });
        cekDanRedirect(res.user);
      } catch (err) {
        tampilkanPesan("❌ " + err.message);
      }
    };

    document.getElementById("googleLoginBtn").onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(res => cekDanRedirect(res.user))
        .catch(err => tampilkanPesan("❌ " + err.message));
    };

    auth.onAuthStateChanged(user => {
      if (user) cekDanRedirect(user);
    });

    // Load wilayah
    fetch("data/wilayah.json")
      .then(res => res.json())
      .then(data => {
        const provSelect = document.getElementById("regProvinsi");
        const kabSelect = document.getElementById("regKabupaten");

        Object.keys(data).forEach(prov => {
          const opt = document.createElement("option");
          opt.value = prov;
          opt.textContent = prov;
          provSelect.appendChild(opt);
        });

        provSelect.addEventListener("change", () => {
          const kabList = data[provSelect.value];
          kabSelect.innerHTML = "<option value=''>Pilih Kabupaten/Kota</option>";
          Object.keys(kabList || {}).forEach(kab => {
            const opt = document.createElement("option");
            opt.value = kab;
            opt.textContent = kab;
            kabSelect.appendChild(opt);
          });
        });
      });
  </script>
</body>
</html>
