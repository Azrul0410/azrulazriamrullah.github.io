<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login / Daftar - FisioKita</title>
  <link rel="stylesheet" href="css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #4B6CC1;
      color: white;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .card {
      background-color: white;
      color: black;
      border-radius: 1rem;
      padding: 2rem;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }
    .tabs {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .tabs button {
      font-weight: 600;
      font-size: 0.9rem;
      background: none;
      border: none;
      cursor: pointer;
    }
    .tabs .active {
      color: #4B6CC1;
      text-decoration: underline;
    }
    .form-group {
      margin-bottom: 1rem;
    }
    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 0.3rem;
    }
    input, select {
      width: 100%;
      padding: 0.5rem 0.75rem;
      font-size: 0.9rem;
      border: 1px solid #ccc;
      border-radius: 0.5rem;
    }
    .btn-primary {
      background-color: #4B6CC1;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      border: none;
      width: 100%;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-primary:hover {
      background-color: #3a57b0;
    }
    .btn-outline {
      background: none;
      border: 1px solid #ccc;
      padding: 0.5rem 1rem;
      width: 100%;
      text-align: center;
      border-radius: 0.5rem;
      font-size: 0.9rem;
      cursor: pointer;
      margin-top: 1rem;
    }
    .divider {
      text-align: center;
      font-size: 0.8rem;
      margin-top: 1rem;
      color: #666;
    }
    #pesan {
      color: red;
      font-size: 0.85rem;
      text-align: center;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>

  <main class="card">
    <h1 class="text-center" style="color: #4B6CC1; font-size: 1.5rem; font-weight: bold;">FisioKita</h1>

    <!-- Tabs -->
    <div class="tabs">
      <button id="btnLoginTab" class="active">Login</button>
      <button id="btnRegisterTab">Register</button>
    </div>

    <!-- Login Form -->
    <form id="loginForm">
      <div class="form-group">
        <label for="loginEmail">Email</label>
        <input type="email" id="loginEmail" required />
      </div>
      <div class="form-group">
        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" required />
      </div>
      <button type="submit" class="btn-primary">Masuk</button>
    </form>

    <!-- Register Form -->
    <form id="registerForm" class="hidden">
      <div class="form-group">
        <label>Nama Lengkap</label>
        <input type="text" id="regNama" required />
      </div>
      <div class="form-group">
        <label>No. HP</label>
        <input type="tel" id="regHP" required />
      </div>
      <div class="form-group">
        <label>Tanggal Lahir</label>
        <input type="date" id="regTanggalLahir" required />
      </div>
      <div class="form-group">
        <label>Jenis Kelamin</label>
        <select id="regGender" required>
          <option value="">Pilih</option>
          <option value="Laki-laki">Laki-laki</option>
          <option value="Perempuan">Perempuan</option>
        </select>
      </div>
      <div class="form-group">
        <label>Provinsi</label>
        <select id="regProvinsi" required></select>
      </div>
      <div class="form-group">
        <label>Kabupaten/Kota</label>
        <select id="regKabupaten" required></select>
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="registerEmail" required />
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="registerPassword" required />
      </div>
      <button type="submit" class="btn-primary">Daftar</button>
    </form>

    <div class="divider">atau</div>

    <button id="googleLoginBtn" class="btn-outline">Masuk dengan Google</button>

    <a href="index.html" class="btn-outline">Kembali ke Beranda</a>

    <p id="pesan"></p>
  </main>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDng3ugBylPgzuxZA1YRPavo5br5jjlodo",
      authDomain: "fisiosehat-af9f1.firebaseapp.com",
      projectId: "fisiosehat-af9f1"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    const btnLoginTab = document.getElementById("btnLoginTab");
    const btnRegisterTab = document.getElementById("btnRegisterTab");
    const pesan = document.getElementById("pesan");

    btnLoginTab.onclick = () => {
      loginForm.classList.remove("hidden");
      registerForm.classList.add("hidden");
      btnLoginTab.classList.add("active");
      btnRegisterTab.classList.remove("active");
      pesan.textContent = "";
    };
    btnRegisterTab.onclick = () => {
      registerForm.classList.remove("hidden");
      loginForm.classList.add("hidden");
      btnRegisterTab.classList.add("active");
      btnLoginTab.classList.remove("active");
      pesan.textContent = "";
    };

    function tampilkanPesan(text) {
      pesan.textContent = text;
    }

    async function cekDanRedirect(user) {
      const email = user.email.toLowerCase();
      if (email === "fisiokita@gmail.com") {
        location.href = "admin/super-admin-dashboard.html";
      } else {
        const doc = await db.collection("terapis").doc(email).get();
        location.href = doc.exists ? "admin/dashboard.html" : "akun.html";
      }
    }

    loginForm.onsubmit = (e) => {
      e.preventDefault();
      const email = loginEmail.value;
      const pass = loginPassword.value;
      auth.signInWithEmailAndPassword(email, pass)
        .then(res => cekDanRedirect(res.user))
        .catch(err => tampilkanPesan("❌ " + err.message));
    };

    registerForm.onsubmit = async (e) => {
      e.preventDefault();
      const nama = regNama.value;
      const hp = regHP.value;
      const tglLahir = regTanggalLahir.value;
      const gender = regGender.value;
      const prov = regProvinsi.value;
      const kab = regKabupaten.value;
      const email = registerEmail.value;
      const pass = registerPassword.value;

      if (!nama || !hp || !tglLahir || !gender || !prov || !kab || pass.length < 6) {
        return tampilkanPesan("❌ Lengkapi semua kolom dan password minimal 6 karakter.");
      }

      try {
        const result = await auth.createUserWithEmailAndPassword(email, pass);
        await db.collection("pengguna").doc(result.user.uid).set({
          nama, hp, tanggal_lahir: tglLahir, jenis_kelamin: gender,
          provinsi: prov, kabupaten: kab, email: result.user.email
        });
        cekDanRedirect(result.user);
      } catch (err) {
        tampilkanPesan("❌ " + err.message);
      }
    };

    document.getElementById("googleLoginBtn").onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(result => cekDanRedirect(result.user))
        .catch(err => tampilkanPesan("❌ " + err.message));
    };

    auth.onAuthStateChanged(user => {
      if (user) cekDanRedirect(user);
    });

    // Wilayah
    fetch("data/wilayah.json")
      .then(res => res.json())
      .then(data => {
        const prov = document.getElementById("regProvinsi");
        const kab = document.getElementById("regKabupaten");
        Object.keys(data).forEach(p => {
          const opt = document.createElement("option");
          opt.value = p;
          opt.textContent = p;
          prov.appendChild(opt);
        });
        prov.onchange = () => {
          kab.innerHTML = "";
          Object.keys(data[prov.value] || {}).forEach(k => {
            const opt = document.createElement("option");
            opt.value = k;
            opt.textContent = k;
            kab.appendChild(opt);
          });
        };
      });
  </script>
</body>
</html>
